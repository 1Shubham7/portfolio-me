<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Building a Golang backend system with JWT authentication | Shubham Singh</title>
<meta name="keywords" content="Golang, Backend, Gin, JWT authentication">
<meta name="description" content="When creating a website&#39;s backend, one very important term we get to hear is JWT authentication. JWT authentication is one of the most popular ways of securing APIs. JWT stands for JSON Web Token and it is an open standard that defines a way for transmitting information between parties as a JSON object and that too securely...">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/blog/jwt/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.2b833c6baa7a96407c2417c7a4049985b42c21cccc2472abf4603967eafd2273.css" integrity="sha256-K4M8a6p6lkB8JBfHpASZhbQsIczMJHKr9GA5Z&#43;r9InM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.2eadbb982468c11a433a3e291f01326f2ba43f065e256bf792dbd79640a92316.js" integrity="sha256-Lq27mCRowRpDOj4pHwEybyukPwZeJWv3ktvXlkCpIxY="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/blog/jwt/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Building a Golang backend system with JWT authentication" />
<meta property="og:description" content="When creating a website&#39;s backend, one very important term we get to hear is JWT authentication. JWT authentication is one of the most popular ways of securing APIs. JWT stands for JSON Web Token and it is an open standard that defines a way for transmitting information between parties as a JSON object and that too securely..." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/blog/jwt/" />
<meta property="og:image" content="http://localhost:1313/blog/jwt-logo.png" /><meta property="article:section" content="blog" />



<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://localhost:1313/blog/jwt-logo.png" />
<meta name="twitter:title" content="Building a Golang backend system with JWT authentication"/>
<meta name="twitter:description" content="When creating a website&#39;s backend, one very important term we get to hear is JWT authentication. JWT authentication is one of the most popular ways of securing APIs. JWT stands for JSON Web Token and it is an open standard that defines a way for transmitting information between parties as a JSON object and that too securely..."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "http://localhost:1313/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Building a Golang backend system with JWT authentication",
      "item": "http://localhost:1313/blog/jwt/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Building a Golang backend system with JWT authentication",
  "name": "Building a Golang backend system with JWT authentication",
  "description": "When creating a website's backend, one very important term we get to hear is JWT authentication. JWT authentication is one of the most popular ways of securing APIs. JWT stands for JSON Web Token and it is an open standard that defines a way for transmitting information between parties as a JSON object and that too securely...",
  "keywords": [
    "Golang", "Backend", "Gin", "JWT authentication"
  ],
  "articleBody": "When creating a website’s backend, one very important term we get to hear is JWT authentication. JWT authentication is one of the most popular ways of securing APIs. JWT stands for JSON Web Token and it is an open standard that defines a way for transmitting information between parties as a JSON object and that too securely. In this article, we will discuss JWT authentication and most importantly we will create an entire project for Fast and Efficient JWT authentication using Gin-Gonic, this will be a step-by-step project tutorial that will help you create a very fast and industry-level authentication API for your website or application’s backend.\nTable of Content:\nWhat is JWT authentication? Project Structure Prerequisites Step by Step Tutorial Final Results Output Conclusion What is JWT authentication? JWT stands for JSON Web Token and it is an open standard that defines a way for transmitting information between parties as a JSON object and that too securely.\nLet’s try to understand that by the help of an example. Consider a situation when we show up at a hotel and we walk up to the front desk and the receptionist says “hey, what can I do for you?”. I would say “Hi, my name is Shubham, I’m here for a conference, the sponsors are paying for my hotel”. The receptionist says “okay great! well I’m going to need to see a couple things”. Usually they’ll need to see my identification so to prove who I am and once that they have verified that I am the right person, they will issue me a key. And authentication works in a very similar way to this example.\nWith JWT authentication, we are making a request out to a server saying “Hey! here’s my username and password or sign-in token is this” and the website says “okay, let me check.” If my username and password is correct then that would give me a token. Now on subsequent requests of the server I don’t have to any longer include my username and password. I would just carry my token and check into the hotel (website), access to the Gym (data), I would have access to the pool(information) and only to my hotel room (account), I don’t have access to any other hotel rooms (other user’s account). This token is only authorized during the duration of my state so from check-in time to the checkout time. After that it is of no use. Now the hotel will also allow people without any verification to at least see the hotel, to roam in the public area around the hotel until you are coming inside the hotel, Similarly being an anonomous user you can interact with the website’s home page, landing page, etc.\nHere’s an example of a JWT :\neyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ .SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c Project Structure Here is the structure of the project. Make sure to create a similar folder structure in your workspace as well. In this structure we have 6 folders:\ncontrollers database helpers middleware models routes and create the respective files inside these folders.\nPrerequisites Go - Version 1.18+ Mongo DB Step by Step Tutorial Step 1. Let’s start the project by creating a module, the name of my module is “jwt” and my username is “1shubham7”, therefore I will initial my module by entering:\ngo mod init github.com/1shubham7/jwt This will create a go.mod file.\nStep 2. Create a main.go file and let’s create a web server in main.go. For that, add the following code in the file:\npackage main import( \"github.com/gin-gonic/gin\" \"os\" routes \"github.com/1shubham7/jwt/routes\" \"github.com/joho/godotenv\" \"log\" ) func main() { err := godotenv.Load(\".env\") if err != nil { log.Fatal(\"Error locading the .env file\") } port := os.Getenv(\"PORT\") if port == \"\" { port = \"1111\" } router := gin.New() router.Use(gin.Logger()) routes.AuthRoutes(router) routes.UserRoutes(router) // creating two APIs router.GET(\"/api-1\", func(c *gin.Context){ c.JSON(200, gin.H{\"success\":\"Access granted for api-1\"}) }) router.GET(\"api-2\", func(c *gin.Context){ c.JSON(200, gin.H{\"success\":\"Access granted for api-2\"}) }) router.Run(\":\" + port) } ‘os’ package to retrieve environment variables. we are using gin-gonic package to create a web server. Later we will create a routes package. AuthRoutes(), UserRoutes() are functions inside a file from routes package, we will create it later on.\nStep 3. Download the gin-gonic package:\ngo get github.com/gin-gonic/gin Step 4. Create a models folder and inside it create a userModel.go file. Enter the following code inside the userModel.go:\npackage models import ( \"go.mongodb.org/mongo-driver/bson/primitive\" \"time\" ) type User struct { ID primitive.ObjectID `bson:\"id\"` First_name *string `json:\"first_name\" validate:\"required, min=2, max=100\"` Last_name *string `json:\"last_name\" validate:\"required, min=2, max=100\"` Password *string `json:\"password\" validate:\"required, min=6\"` Email *string `json:\"email\" validate:\"email, required\"` //validate email means it should have an @ Phone *string `json:\"phone\" validate:\"required\"` Token *string `json:\"token\"` User_type *string `json:\"user_type\" validate:\"required, eq=ADMIN|eq=USER\"` Refresh_token *string `json:\"refresh_token\"` Created_at time.Time `json:\"created_at\"` Updated_at time.Time `json:\"updated_at\"` User_id string `json:\"user_id\"` } We have created a struct called User and have added necessary fields to the struct.\njson:\"first_name\" validate:\"required, min=2, max=100\" this are called field tags, these are used during decoding and encoding of go code to JSON and JSON to go. Here validate:“required, min=2, max=100” this is used for validate that the particular field must have minimum 2 characters and maximum 100 characters.\nStep 5. Create a database folder and inside it create a databaseConnection.go file, enter the following code inside it:\npackage database import ( \"fmt\" \"log\" \"os\" \"time\" \"context\" \"github.com/joho/godotenv\" \"go.mongodb.org/mongo-driver/mongo\" \"go/mongodb.org/mongo-driver/mongo/options\" ) func DBinstance() *mongo.Client{ err := godotenv.Load(\".env\") if err != nil { log.Fatal(\"Error locading the .env file\") } MongoDb := os.Getenv(\"THE_MONGODB_URL\") client, err := mongo.NewClient(options.Client().ApplyURI(MongoDb)) if err != nil { log.Fatal(err) } ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second) defer cancel() err = client.Connect(ctx) if err!=nil{ log.Fatal(err) } fmt.Println(\"Connected to MongoDB!!\") return client } var Client *mongo.Client = DBinstance() func OpenCollection(client *mongo.Client, collectionName string) *mongo.Collection { var collection *mongo.Collection = client.Database(\"cluster0\").Collection(collectionName) return collection } also make sure to download the ‘mongo’ package:\ngo get go.mongodb.org/mongo-driver/mongo Here we are connecting your mongo database with the application.\nwe are using ‘godotenv’ for loading environment variables that we will set in the .env file in main directory. The DBinstance Function, we take the value of “THE_MONGODB_URL” from the .env file (we will create that in the coming steps) and create a new mongoDB client using the value. ‘context’ is used to have a timeout of 10 seconds. OpenCollection Function() takes client and collectionName as input and creates a collection for it.\nStep 6. For the routes, we will create two different files, authRouter and userRouter. authRouter includes ‘/signup’ and ‘/login’ . These will public to everyone so that they can authorize themselves. userRouter will not be public to everyone. It will include ‘/users’ and ‘/users/:user_id’.\nCreate a folder called routes and add two files into it:\nuserRouter.go authRouter.go enter the following code into userRouter.go:\npackage routes import ( \"github.com/gin-gonic/gin\" controllers \"github.com/1shubham7/jwt/controllers\" middleware \"github.com/1shubham7/jwt/middleware\" ) // user should not be able to use userRoute without the token func UserRoutes (incomingRoutes *gin.Engine) { incomingRoutes.Use(middleware.Authenticate()) // user routes are public routes but these must be authenticated, that // is why we have Authenticate() before these incomingRoutes.GET(\"/users\", controllers.GetUsers()) incomingRoutes.GET(\"users/:user_id\", controllers.GetUserById()) } Step 7. enter the following code into the authRouter.go:\npackage routes import ( \"github.com/gin-gonic/gin\" controllers \"github.com/1shubham7/jwt/controllers\" ) // this is when the user has not signed up. userRouter is when the user has logged in // and has the token. func AuthRoutes(incomingRoutes *gin.Engine) { incomingRoutes.POST(\"users/signup\", controllers.SignUp()) incomingRoutes.POST(\"user/login\", controllers.Login()) } Step 8. create a folder called controllers and add a file called ‘userController.go’ to it. enter the following code inside it.\npackage controllers import ( \"context\" \"fmt\" \"log\" \"net/http\" \"strconv\" \"time\" database \"github.com/1shubham7/jwt/database\" helper \"github.com/1shubham7/jwt/helpers\" models \"github.com/1shubham7/jwt/models\" \"github.com/gin-gonic/gin\" \"github.com/go-playground/validator/v10\" \"golang.org/x/crypto/bcrypt\" ) var userCollection *mongo.Collection = database.OpenCollection(database.Client, \"user\") func Hashpassword() func VerifyPassword() func SignUp() func Login() func GetUsers() func GetUserById() The packages used are straight forward. database, helper and models are our own packages. 'fmt' package is used for string formatting. 'time' package is used for time representation 'net/http' package is used for dealing with requests 'strconv' package is used to convert string to int and vice versa. Then we have just created the outline function, we will complete those functions in the coming steps. Step 9. To keep environment variables in a separate file, we will create a .env file inside the main folder (root folder) and add the following code into it: PORT=1111 THE_MONGODB_URL=mongodb://localhost:27017/go-auth These two variables have already been used in our previous code.\nStep 10. Let’s create the GetUserById() function first. Enter the following code in GetUserById() function:\nfunc GetUserById() gin.HandlerFunc{ return func(c *gin.Context){ userId := c.Param(\"user_id\") // we are taking the user_id given by the user in json // with the help of gin.context we can access the json data send by postman or curl or user if err := helper.MatchUserTypeToUserId(c, userId); err != nil{ //checking if the user in admin or not. // we will create that func in helper package. c.JSON(http.StatusBadRequest, gin.H{\"error\": err.Error()}) return } var ctx, cancel = context.WithTimeout(context.Background(), 100*time.Second) var user models.User err := userCollection.FindOne(ctx, bson.M{\"user_id\": userId}).Decode(\u0026user) defer cancel() if err != nil { c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } // if everything goes ok, pass the data of the user (UserModel.go) c.JSON(http.StatusOK, user) } } Step 11. Let’s create a folder called helpers and add a file called authHelper.go into it. Enter the following code into the authHelper.go :\npackage helpers import ( \"errors\" \"github.com/gin-gonic/gin\" ) func CheckUserType(c *gin.Context, userOrAdmin string) (err error) { userType := c.GetString(\"user_type\") err = nil if userType != userOrAdmin { err = errors.New(\"Not authorized to access the resource\") return err } return err } func MatchUserTypeToUserId(c *gin.Context, userId string) (err error) { // This is the match user function userType := c.GetString(\"user_type\") uid := c.GetString(\"uid\") err = nil // this means that user is USER not ADMIN and uid is not of the user. Because user can only access his id, // admin can access anyone's id if userId == \"USER\" \u0026\u0026 uid != userId { err = errors.New(\"You are not authorized to access this user\") } err = CheckUserType(c, userType) return err } The MatchUserTypeToUserId() function just matches if the user is a Admin or just a user. We are using CheckUserType() function inside MatchUserTypeToUserId(), this is just checking if everything is fine (if the user_type we get from user is same as the userType variable.\nStep 12. We can now work on the SignUp() function of userController.go:\nfunc SignUp()gin.HandlerFunc{ return func(c *gin.Context){ var ctx, cancel = context.WithTimeout(context.Background(), 100*time.Second) var user models.User if err := c.BindJSON(\u0026user); err!=nil{ c.JSON(http.StatusBadRequest, gin.H{\"error\": err.Error()}) return } validationErr := validate.Struct(user) // this is used to validate, but what? see the User struct, and see those validate struct fields if validationErr != nil { c.JSON(http.StatusBadRequest, gin.H{\"error\": validationErr.Error()}) return } // we are using count to help us validate. if you find documents with the user email already // then count would be more than 0, and we can then handle that err count, err := userCollection.CountDocuments(ctx, bson.M{\"email\":user.Email}) defer cancel() if err != nil { log.Panic(err) c.JSON(http.StatusInternalServerError, gin.H{\"error\":\"error occured while checking for the email\"}) } password := HashPassword(*user.Password) user.Password = \u0026password count, err = userCollection.CountDocuments(ctx, bson.M{\"phone\":user.Phone}) defer cancel() if err != nil { log.Panic(err) c.JSON(http.StatusInternalServerError, gin.H{\"error\":\"error occured while checking for the phone number\"}) } if count \u003e 0 { c.JSON(http.StatusInternalServerError, gin.H{\"error\":\"this email or phone number already exists\"}) } // by \"c.BindJSON(\u0026user)\" user already have the information from the website user user.Created_at, _ = time.Parse(time.RFC3339, time.Now().Format(time.RFC3339)) user.Updated_at, _ = time.Parse(time.RFC3339, time.Now().Format(time.RFC3339)) user.ID = primitive.NewObjectID() user.User_id = user.ID.Hex() token, refreshToken, _ := helper.GenerateAllTokens(*user.Email, *user.First_name, *user.Last_name, *user.User_type, *\u0026user.User_id) // giving value that we generated to user user.Token = \u0026token user.Refresh_token = \u0026refreshToken // now let's insert it to the database resultInsertionNumber, insertErr := userCollection.InsertOne(ctx, user) if insertErr != nil { msg := fmt.Sprintf(\"User item was not created\") c.JSON(http.StatusInternalServerError, gin.H{\"error\": msg}) return } defer cancel() c.JSON(http.StatusOK, resultInsertionNumber) } } We created a variable user of type User.\nvalidationErr is used to validate the struct tags, we already discussed this.\nWe are also using count variable to validate. As in if we find documents with the user email already then the count would be more than 0, and we can then handle that error (err)\nThen we are using ’time.Parse(time.RFC3339, time.Now().Format(time.RFC3339))’ to set the time for Created_at, Updated_at struct fields. When the user tries to sign up, the function SignUp() will run and that particular time will be stored in Created_at, Updated_at struct fields.\nThen we are creating tokens using GenerateAllTokens() function that we will create in tokenHelper.go file in the same package in the next step.\nWe also have a HashPassword() function that is doing nothing but hashing the user.password and replacing the user.password with the hashed password. We will also create that thing later.\nAnd then we are just inserting the data and the tokens etc. to the userCollection\nIf everything goes right, we will give StatusOK back.\nStep 13. create a file in helpers folder called ’tokenHelper.go’ and enter the following code inside it.\npackage helpers import ( \"context\" \"fmt\" \"log\" \"os\" \"time\" \"github.com/1shubham7/jwt/database\" jwt \"github.com/dgrijalva/jwt-go\" // golang driver for jwt \"go.mongodb.org/mongo-driver/bson\" \"go.mongodb.org/mongo-driver/bson/primitive\" \"go.mongodb.org/mongo-driver/mongo\" \"go.mongodb.org/mongo-driver/mongo/options\" ) type SignedDetails struct { Email string First_name string Last_name string Uid string User_type string jwt.StandardClaims } var userCollection *mongo.Collection = database.OpenCollection(database.Client, \"user\") // btw we sould have our secret key in .env for production var SECRET_KEY string = os.Getenv(\"SECRET_KEY\") func GenerateAllTokens(email string, firstName string, lastName string, userType string, uid string) (signedToken string, signedRefreshToken string, err error){ claims := \u0026SignedDetails{ Email : email, First_name: firstName, Last_name: lastName, Uid : uid, User_type: userType, StandardClaims: jwt.StandardClaims{ // setting the expiry time ExpiresAt: time.Now().Local().Add(time.Hour *time.Duration(120)).Unix(), }, } // refreshClaims is used to get a new token if th eprevious once is expired. refreshClaims := \u0026SignedDetails{ StandardClaims: jwt.StandardClaims{ ExpiresAt: time.Now().Local().Add(time.Hour *time.Duration(172)).Unix(), }, } token ,err := jwt.NewWithClaims(jwt.SigningMethodHS256, claims).SignedString([]byte(SECRET_KEY)) refreshToken, err := jwt.NewWithClaims(jwt.SigningMethodHS256, refreshClaims).SignedString([]byte(SECRET_KEY)) if err!= nil{ log.Panic(err) return } return token, refreshToken, err } Also make sure to download the github.com/dgrijalva/jwt-go package:\ngo get github.com/dgrijalva/jwt-go Here we are using github.com/dgrijalva/jwt-go for generating tokens.\nWe are creating a struct called SignedDetails with field names required for generating tokens.\nwe are using NewWithClaims to generate new tokens and are giving the value to the claims and refreshClaims structs. claims has token for the first time users and refreshClaims has it when the user has to refresh the token. that is, they previously had a token which is now expired.\ntime.Now().Local().Add(time.Hour *time.Duration(120)).Unix() is being used for setting the expiry of the token.\nwe are then simply returning three things - token, refreshToken and err which we are using in the SignUp() function.\nStep 14. In the same file as SignUp() function, let’s create the HashPassword() function we talked about in step 9.\nfunc HashPassword(password string) string { hashed, err:=bcrypt.GenerateFromPassword([]byte(password), 14) if err!=nil{ log.Panic(err) } return string(hashed) } We are simply using the GenerateFromPassword() method from bcrypt package which is used to generate hashed passwords from the actual password.\nThis is important because we would not want and hacker to hack into our systems and steal all the passwords, also for the users privacy.\n[]byte (array of bytes) is simply string.\nStep 15. Let’s create the Login() function in ‘userController.go’ and in later steps we can create the functions that Login() uses:\nfunc Login() gin.HandlerFunc{ return func(c *gin.Context) { var ctx, cancel = context.WithTimeout(context.Background(), 100*time.Second) var user models.User var foundUser models.User // giving the user data to user variable if err := c.BindJSON(\u0026user); err != nil { c.JSON(http.StatusBadRequest, gin.H{\"error\": err.Error()}) return } // finding the user through email and if found, storing it in foundUser variable err := userCollection.FindOne(ctx, bson.M{\"email\": user.Email}).Decode(\u0026foundUser) defer cancel() if err!=nil{ c.JSON(http.StatusInternalServerError, gin.H{\"error\": \"email or password is incorrect\"}) return } // we need pointer to acess the origina user and foundUser, // if we only pass user and foundUser, it will create a new instance of user and foundUser isPasswordValid, msg := VerifyPassword(*user.Password, *foundUser.Password) defer cancel() if isPasswordValid != true{ c.JSON(http.StatusInternalServerError, gin.H{\"error\": msg}) return } if foundUser.Email == nil { c.JSON(http.StatusInternalServerError, gin.H{\"error\": \"user not found\"}) } token, refreshToken, _ := helper.GenerateAllTokens(*foundUser.Email, *foundUser.First_name, *foundUser.Last_name, *foundUser.User_type, foundUser.User_id) helper.UpdateAllTokens(token, refreshToken, foundUser.User_id) err = userCollection.FindOne(ctx, bson.M{\"user_id\":foundUser.User_id}).Decode(\u0026foundUser) if err != nil { c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } c.JSON(http.StatusOK, foundUser) } } We are creating two variables of type User, these are user and Founduser. and giving the data from request to user.\nBy the help of ‘userCollection.FindOne(ctx, bson.M{“email”: user.Email}).Decode(\u0026foundUser)’ we are finding the user through his/her email and if found, storing it in foundUser variable.\nThen we are using VerifyPassword() function to verify the password and store it, remember that we are taking pointers as parameters in VerifyPassword(), if not, it would create a new instance of those in parameters rather than actually changing them.\nWe will create VerifyPassword() in the next step.\nThen we are simply using GenerateAllTokens() and UpdateAllTokens() to generate and update the token and refreshToken (which are basically tokens).\nAnd every step, we are all handling the errors.\nStep 16. Let’s create the VerifyPassword() function in the same file as Login() function:\nfunc VerifyPassword(userPassword, providedPassword string) (bool, string) { err := bcrypt.CompareHashAndPassword([]byte(providedPassword), []byte(userPassword)) check := true msg := \"\" if err != nil { check = false msg = fmt.Sprintf(\"email or password is incorrect.\") } return check, msg } We are simply using the CompareHashAndPassword() method from bcrypt package which is used to compare hashed passwords. and returning a boolean value depening on the results.\n[]byte (array of bytes) is simply string, but []byte helps in comparing.\nStep 17. Let’s create the UpdateAllTokens() function in the ’tokenHelper.go’ file:\nfunc UpdateAllTokens(signedToken string, signedRefreshToken string, userId string){ var ctx, cancel = context.WithTimeout(context.Background(), 100*time.Second) var updateObj primitive.D updateObj = append(updateObj, bson.E{\"token\", signedToken}) updateObj = append(updateObj, bson.E{\"refresh_token\", signedRefreshToken}) Updated_at, _ := time.Parse(time.RFC3339, time.Now().Format(time.RFC3339)) updateObj = append(updateObj, bson.E{\"updated_at\", Updated_at}) upsert := true filter := bson.M{\"user_id\":userId} opt := options.UpdateOptions{ Upsert: \u0026upsert, } _, err := userCollection.UpdateOne( ctx, filter, bson.D{ {\"$set\", updateObj}, }, \u0026opt, ) defer cancel() if err!=nil{ log.Panic(err) return } return } We are creating a variable called updateObj which is of type primitive.D. primitive.D type in MongoDB’s Go driver is a representation of a BSON document.\nAppend() is appending a key-value pair to updateObj each and every time its running.\nThen ’time.Parse(time.RFC3339, time.Now().Format(time.RFC3339))’ is used to update the current time (time when the updation happens and the function runs) to Updated_at.\nRest of the code block is performing update using the UpdateOne method of mongoDB collection.\nAt the last step we are also handling the error in case any error occurs.\nStep 18. Before continuing ahead, let’s download the go.mongodb.org/mongo-driver package:\ngo get go.mongodb.org/mongo-driver Step 19. Let’s now work on GetUserById() function. Remember that GetUserById() is for the users to access there own information, Admins can access all the users data, users can only access theirs.\nfunc GetUserById() gin.HandlerFunc{ return func(c *gin.Context){ userId := c.Param(\"user_id\") // we are taking the user_id given by the user in json // with the help of gin.context we can access the json data send by postman or curl or user if err := helper.MatchUserTypeToUserId(c, userId); err != nil{ //checking if the user in admin or not. // we will create that func in helper package. c.JSON(http.StatusBadRequest, gin.H{\"error\": err.Error()}) return } var ctx, cancel = context.WithTimeout(context.Background(), 100*time.Second) var user models.User err := userCollection.FindOne(ctx, bson.M{\"user_id\": userId}).Decode(\u0026user) defer cancel() if err != nil { c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } // if everything goes ok, pass the data of the user (UserModel.go) c.JSON(http.StatusOK, user) } } Taking the user_id from the request and storing it in userId variable.\ncreating a variable called user of type User. then simply searching the user in our database with the help of user_id, if the user_id matches, we will store that persons information in user variable.\nIf everything goes fine, StatusOk\nwe are also handling the errors at every step.\nStep 20. Let’s now work on GetUsers() function. Remember that only the admin can access the GetUsers() function because it would include the data of all the users. Create a GetUsers() function in the same file as GetUserById(), Login() and SignUp() function:\nfunc GetUsers() gin.HandlerFunc{ return func(c *gin.Context){ if err := helper.CheckUserType(c, \"ADMIN\"); err != nil{ c.JSON(http.StatusBadRequest, gin.H{\"error\":err.Error()}) return } var ctx, cancel = context.WithTimeout(context.Background(), 100*time.Second) // setting how many records you want per page. // we are taking the recodePerPage from c and converting it to int recordPerPage, err := strconv.Atoi(c.Query(\"recordPerPage\")) // if error or recordPerPage is less than 1, by default we will have 9 records per page if recordPerPage\u003c1||err != nil { recordPerPage = 9 } // this is just like page number page, err1 := strconv.Atoi(c.Query(\"page\")) // we want to start with the page number 1 by default. if err1 !=nil || page \u003c 1{ page = 1 } startIndex := (page - 1) * recordPerPage startIndex, err = strconv.Atoi(c.Query(\"startIndex\")) matchStage := bson.D{{\"$match\", bson.D{{}}, }} // group all the data based on id, and then count them using $sum. then // pushing all the data to the root. groupStage := bson.D{{\"$group\", bson.D{{\"_id\", bson.D{{\"_id\", \"null\"}}}, {\"total_count\", bson.D{{\"$sum\", 1}}}, {\"data\", bson.D{{\"$push\", \"$$ROOT\"}}}, }}} // in project stage we deside which data should go to the user and which not. projectStage := bson.D{ {\"$project\", bson.D{ {\"_id\", 0}, {\"total_count\", 1}, {\"user_items\", bson.D{{\"$slice\", []interface{}{\"$data\", startIndex, recordPerPage}}}}, }}, } result, err := userCollection.Aggregate(ctx, mongo.Pipeline{ matchStage, groupStage, projectStage}) defer cancel() if err != nil{ c.JSON(http.StatusInternalServerError, gin.H{\"error\":\"error occured while listing user items\"}) } // creating a slice called allUser and giving the result value var allUsers []bson.M if err := result.All(ctx, \u0026allUsers); err != nil { log.Fatal(err) } c.JSON(http.StatusOK, allUsers[0]) } } Firstly, we will check if the request is coming from the admin or not, we do that by the help of CheckUserType() we created in previous steps.\nThen we are setting how many records you want per page.\nWe can do that by taking the recodePerPage from the request and converting it to int, this is done by srtconv.\nIf any error occurs in setting recordPerPage or recordPerPage is less than 1, by default we will have 9 records per page\nSimilarly we are taking the page number in variable ‘page’.\nBy default we will have page number as 1 and 9 recordPerPage.\nThen we created three stages (matchStage, groupStage, projectStage).\nThen we are setting these three stages in our Mongo pipeline using Aggregate() function\nAlso we are handling errors are every step.\nStep 21. Our ‘userController.go’ is now ready, this is how the ‘userController.go’ file looks like after completion:\npackage controllers import ( \"context\" \"fmt\" \"log\" \"net/http\" \"strconv\" \"time\" database \"github.com/1shubham7/jwt/database\" helper \"github.com/1shubham7/jwt/helpers\" models \"github.com/1shubham7/jwt/models\" \"github.com/gin-gonic/gin\" \"github.com/go-playground/validator/v10\" \"golang.org/x/crypto/bcrypt\" \"go.mongodb.org/mongo-driver/bson\" \"go.mongodb.org/mongo-driver/bson/primitive\" \"go.mongodb.org/mongo-driver/mongo\" ) var userCollection *mongo.Collection = database.OpenCollection(database.Client, \"user\") var validate = validator.New() func HashPassword(password string) string { hashed, err:=bcrypt.GenerateFromPassword([]byte(password), 14) if err!=nil{ log.Panic(err) } return string(hashed) } func VerifyPassword(userPassword, providedPassword string) (bool, string) { err := bcrypt.CompareHashAndPassword([]byte(providedPassword), []byte(userPassword)) check := true msg := \"\" if err != nil { check = false msg = fmt.Sprintf(\"email or password is incorrect.\") } return check, msg } func SignUp()gin.HandlerFunc{ return func(c *gin.Context){ var ctx, cancel = context.WithTimeout(context.Background(), 100*time.Second) var user models.User if err := c.BindJSON(\u0026user); err!=nil{ c.JSON(http.StatusBadRequest, gin.H{\"error\": err.Error()}) return } validationErr := validate.Struct(user) // this is used to validate, but what? see the User struct, and see those validate struct fields if validationErr != nil { c.JSON(http.StatusBadRequest, gin.H{\"error\": validationErr.Error()}) return } // we are using count to help us validate. if you find documents with the user email already // then count would be more than 0, and we can then handle that err count, err := userCollection.CountDocuments(ctx, bson.M{\"email\":user.Email}) defer cancel() if err != nil { log.Panic(err) c.JSON(http.StatusInternalServerError, gin.H{\"error\":\"error occured while checking for the email\"}) } password := HashPassword(*user.Password) user.Password = \u0026password count, err = userCollection.CountDocuments(ctx, bson.M{\"phone\":user.Phone}) defer cancel() if err != nil { log.Panic(err) c.JSON(http.StatusInternalServerError, gin.H{\"error\":\"error occured while checking for the phone number\"}) } if count \u003e 0 { c.JSON(http.StatusInternalServerError, gin.H{\"error\":\"this email or phone number already exists\"}) } // by \"c.BindJSON(\u0026user)\" user already have the information from the website user user.Created_at, _ = time.Parse(time.RFC3339, time.Now().Format(time.RFC3339)) user.Updated_at, _ = time.Parse(time.RFC3339, time.Now().Format(time.RFC3339)) user.ID = primitive.NewObjectID() user.User_id = user.ID.Hex() token, refreshToken, _ := helper.GenerateAllTokens(*user.Email, *user.First_name, *user.Last_name, *user.User_type, *\u0026user.User_id) // giving value that we generated to user user.Token = \u0026token user.Refresh_token = \u0026refreshToken // now let's insert it to the database resultInsertionNumber, insertErr := userCollection.InsertOne(ctx, user) if insertErr != nil { msg := fmt.Sprintf(\"User item was not created\") c.JSON(http.StatusInternalServerError, gin.H{\"error\": msg}) return } defer cancel() c.JSON(http.StatusOK, resultInsertionNumber) } } func Login() gin.HandlerFunc{ return func(c *gin.Context) { var ctx, cancel = context.WithTimeout(context.Background(), 100*time.Second) var user models.User var foundUser models.User // giving the user data to user variable if err := c.BindJSON(\u0026user); err != nil { c.JSON(http.StatusBadRequest, gin.H{\"error\": err.Error()}) return } // finding the user through email and if found, storing it in foundUser variable err := userCollection.FindOne(ctx, bson.M{\"email\": user.Email}).Decode(\u0026foundUser) defer cancel() if err!=nil{ c.JSON(http.StatusInternalServerError, gin.H{\"error\": \"email or password is incorrect\"}) return } // we need pointer to acess the origina user and foundUser, // if we only pass user and foundUser, it will create a new instance of user and foundUser isPasswordValid, msg := VerifyPassword(*user.Password, *foundUser.Password) defer cancel() if isPasswordValid != true{ c.JSON(http.StatusInternalServerError, gin.H{\"error\": msg}) return } if foundUser.Email == nil { c.JSON(http.StatusInternalServerError, gin.H{\"error\": \"user not found\"}) } token, refreshToken, _ := helper.GenerateAllTokens(*foundUser.Email, *foundUser.First_name, *foundUser.Last_name, *foundUser.User_type, foundUser.User_id) helper.UpdateAllTokens(token, refreshToken, foundUser.User_id) err = userCollection.FindOne(ctx, bson.M{\"user_id\":foundUser.User_id}).Decode(\u0026foundUser) if err != nil { c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } c.JSON(http.StatusOK, foundUser) } } // GetUsers can only be accessed by the admin. func GetUsers() gin.HandlerFunc{ return func(c *gin.Context){ if err := helper.CheckUserType(c, \"ADMIN\"); err != nil{ c.JSON(http.StatusBadRequest, gin.H{\"error\":err.Error()}) return } var ctx, cancel = context.WithTimeout(context.Background(), 100*time.Second) // setting how many records you want per page. // we are taking the recodePerPage from c and converting it to int recordPerPage, err := strconv.Atoi(c.Query(\"recordPerPage\")) // if error or recordPerPage is less than 1, by default we will have 9 records per page if recordPerPage\u003c1||err != nil { recordPerPage = 9 } // this is just like page number page, err1 := strconv.Atoi(c.Query(\"page\")) // we want to start with the page number 1 by default. if err1 !=nil || page \u003c 1{ page = 1 } startIndex := (page - 1) * recordPerPage startIndex, err = strconv.Atoi(c.Query(\"startIndex\")) matchStage := bson.D{{\"$match\", bson.D{{}}, }} // group all the data based on id, and then count them using $sum. then // pushing all the data to the root. groupStage := bson.D{{\"$group\", bson.D{{\"_id\", bson.D{{\"_id\", \"null\"}}}, {\"total_count\", bson.D{{\"$sum\", 1}}}, {\"data\", bson.D{{\"$push\", \"$$ROOT\"}}}, }}} // in project stage we deside which data should go to the user and which not. projectStage := bson.D{ {\"$project\", bson.D{ {\"_id\", 0}, {\"total_count\", 1}, {\"user_items\", bson.D{{\"$slice\", []interface{}{\"$data\", startIndex, recordPerPage}}}}, }}, } result, err := userCollection.Aggregate(ctx, mongo.Pipeline{ matchStage, groupStage, projectStage}) defer cancel() if err != nil{ c.JSON(http.StatusInternalServerError, gin.H{\"error\":\"error occured while listing user items\"}) } // creating a slice called allUser and giving the result value var allUsers []bson.M if err := result.All(ctx, \u0026allUsers); err != nil { log.Fatal(err) } c.JSON(http.StatusOK, allUsers[0]) } } func GetUserById() gin.HandlerFunc{ return func(c *gin.Context){ userId := c.Param(\"user_id\") // we are taking the user_id given by the user in json // with the help of gin.context we can access the json data send by postman or curl or user if err := helper.MatchUserTypeToUserId(c, userId); err != nil{ //checking if the user in admin or not. // we will create that func in helper package. c.JSON(http.StatusBadRequest, gin.H{\"error\": err.Error()}) return } var ctx, cancel = context.WithTimeout(context.Background(), 100*time.Second) var user models.User err := userCollection.FindOne(ctx, bson.M{\"user_id\": userId}).Decode(\u0026user) defer cancel() if err != nil { c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } // if everything goes ok, pass the data of the user (UserModel.go) c.JSON(http.StatusOK, user) } } Step 22. Now we can work on the authentication part. For that we will create a authenticate middleware. Create a folder called ‘middleware’ and create a file inside it called ‘authMiddleware.go’. Enter the following code in the file:\npackage middleware import ( \"net/http\" \"github.com/gin-gonic/gin\" \"fmt\" helpers \"github.com/1shubham7/jwt/helpers\" ) func Authenticate() gin.HandlerFunc{ return func(c *gin.Context) { clientToken := c.Request.Header.Get(\"token\") if clientToken == \"\" { c.JSON(http.StatusInternalServerError, gin.H{\"error\":fmt.Sprintf(\"No Authorization header provided\")}) c.Abort() return } claims, err := helpers.ValidateToken(clientToken) if err !=\"\" { c.JSON(http.StatusInternalServerError, gin.H{\"error\":err}) c.Abort() return } c.Set(\"email\", claims.Email) c.Set(\"first_name\", claims.First_name) c.Set(\"last_name\", claims.Last_name) c.Set(\"uid\", claims.Uid) c.Set(\"user_type\", claims.User_type) c.Next() } } Step 23. Now let’s create ValidateToken() function, we will create this function in the ’tokenHelper.go’:\nfunc ValidateToken(signedToken string) (claims *SignedDetails, msg string) { // this function is basically returning the token token, err := jwt.ParseWithClaims( signedToken, \u0026SignedDetails{}, func(token *jwt.Token)(interface{}, error){ return []byte(SECRET_KEY), nil }, ) if err != nil { msg = err.Error() return } // checking if the token is correct or not claims, ok := token.Claims.(*SignedDetails) if !ok { msg = fmt.Sprintf(\"the token is invalid\") msg = err.Error() return } // if the token is expired, give error message if claims.ExpiresAt \u003c time.Now().Local().Unix(){ msg = fmt.Sprintf(\"token has been expired\") msg = err.Error() return } return claims, msg } ValidateToken takes signedToken and returns SignedDetails of that along with an error message. \"\" if there is no error.\nParseWithClaims() function is being used to get us the token and store it in a variable called token.\nThen we are checking if the token is correct or not using the Claims method on token. And we are storing the result in claims variable.\nThen we are checking if the token has expired using ExpiresAt() function, if current time is greater than the ExpiresAt time, it would have expired.\nAnd then simply return the claims variable as well as the message.\nStep 24. We are mostly done now, let’s do ‘go mod tidy’, this command checks in your go.mod file, it deletes all the packages/dependencies that we installed but are not using and downloads any dependencies that we are using but haven’t downloaded yet.\ngo mod tidy Output With that our JWT authentication project is ready, to finally run the application enter the following command in the terminal:\ngo run main.go You will get a similar output:\nThis will get the server up and running, and you can use curl or Postman API for sending request and receiving response. Or you can simply integrate this API with an frontend framework. And with that, our authentication API is ready, pat yourself on the back!\nConclusion In this article we discussed one of the fastest ways to create JWT authentication, we used Gin-Gonic framework for our project. This is not your “just another authentication API”. Gin is 300% faster than NodeJS, that makes this authentication API really fast and efficient. The project structure we are using is also an industry level project structure. You can make further changes like storing the SECRET_KEY in the .env file and a lot more to make this API better. You can also find the source code for this project here - 1Shubham7/go-jwt-token.\nMake sure to follow all the steps in order to create the project and add some more functionality and just play with the code to understand it better. The best way to learn authentication is to create your own projects.\n",
  "wordCount" : "5113",
  "inLanguage": "en",
  "image":"http://localhost:1313/blog/jwt-logo.png","datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/blog/jwt/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Shubham Singh",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header sticky-header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Shubham Singh (Alt + H)">Shubham Singh</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/experience" title="Experience">
                    <span>Experience</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/blog" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/projects" title="Projects">
                    <span>Projects</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/blog/">Blogs</a></div>
    <h1 class="post-title">
      Building a Golang backend system with JWT authentication
    </h1>
    <div class="post-description">
      When creating a website&#39;s backend, one very important term we get to hear is JWT authentication. JWT authentication is one of the most popular ways of securing APIs. JWT stands for JSON Web Token and it is an open standard that defines a way for transmitting information between parties as a JSON object and that too securely...
    </div>
    <div class="post-meta">


October 2024

</div>
  </header> 
<figure class="entry-cover"><img loading="lazy" src="http://localhost:1313/blog/jwt-logo.png" alt="">
        
</figure><div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">‎ Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#what-is-jwt-authentication" aria-label="What is JWT authentication?">What is JWT authentication?</a></li>
                <li>
                    <a href="#project-structure" aria-label="Project Structure">Project Structure</a><ul>
                        
                <li>
                    <a href="#prerequisites" aria-label="Prerequisites">Prerequisites</a></li></ul>
                </li>
                <li>
                    <a href="#output" aria-label="Output">Output</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>When creating a website&rsquo;s backend, one very important term we get to hear is JWT authentication. JWT authentication is one of the most popular ways of securing APIs. JWT stands for JSON Web Token and it is an open standard that defines a way for transmitting information between parties as a JSON object and that too securely. In this article, we will discuss JWT authentication and most importantly we will create an entire project for Fast and Efficient JWT authentication using Gin-Gonic, this will be a step-by-step project tutorial that will help you create a very fast and industry-level authentication API for your website or application&rsquo;s backend.</p>
<p><strong>Table of Content:</strong></p>
<ul>
<li>What is JWT authentication?</li>
<li>Project Structure</li>
<li>Prerequisites</li>
<li>Step by Step Tutorial</li>
<li>Final Results</li>
<li>Output</li>
<li>Conclusion</li>
</ul>
<h2 id="what-is-jwt-authentication">What is JWT authentication?<a hidden class="anchor" aria-hidden="true" href="#what-is-jwt-authentication">#</a></h2>
<p>JWT stands for JSON Web Token and it is an open standard that defines a way for transmitting information between parties as a JSON object and that too securely.</p>
<p>Let&rsquo;s try to understand that by the help of an example. Consider a situation when we show up at a hotel and we walk up to the front desk and the receptionist says &ldquo;hey, what can I do for you?&rdquo;. I would say &ldquo;Hi, my name is Shubham, I&rsquo;m here for a conference, the sponsors are paying for my hotel&rdquo;. The receptionist says &ldquo;okay great! well I&rsquo;m going to need to see a couple things&rdquo;. Usually they&rsquo;ll need to see my identification so to prove who I am and once that they have verified that I am the right person, they will issue me a key. And authentication works in a very similar way to this example.</p>
<p>With JWT authentication, we are making a request out to a server saying &ldquo;Hey! here&rsquo;s my username and password or sign-in token is this&rdquo; and the website says &ldquo;okay, let me check.&rdquo; If my username and password is correct then that would give me a token. Now on subsequent requests of the server I don&rsquo;t have to any longer include my username and password. I would just carry my token and check into the hotel (website), access to the Gym (data), I would have access to the pool(information) and only to my hotel room (account), I don&rsquo;t have access to any other hotel rooms (other user&rsquo;s account). This token is only authorized during the duration of my state so from check-in time to the checkout time. After that it is of no use. Now the hotel will also allow people without any verification to at least see the hotel, to roam in the public area around the hotel until you are coming inside the hotel, Similarly being an anonomous user you can interact with the website&rsquo;s home page, landing page, etc.</p>
<p><strong>Here&rsquo;s an example of a JWT :</strong></p>
<pre tabindex="0"><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ 
.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
</code></pre><h2 id="project-structure">Project Structure<a hidden class="anchor" aria-hidden="true" href="#project-structure">#</a></h2>
<p>Here is the structure of the project. Make sure to create a similar folder structure in your workspace as well. In this structure we have 6 folders:</p>
<ol>
<li>controllers</li>
<li>database</li>
<li>helpers</li>
<li>middleware</li>
<li>models</li>
<li>routes</li>
</ol>
<p>and create the respective files inside these folders.</p>
<p><img loading="lazy" src="/blog/jwt/one.webp" alt="Project Structure"  />
</p>
<h3 id="prerequisites">Prerequisites<a hidden class="anchor" aria-hidden="true" href="#prerequisites">#</a></h3>
<ol>
<li>Go - Version 1.18+</li>
<li>Mongo DB</li>
<li>Step by Step Tutorial</li>
</ol>
<p><strong>Step 1.</strong> Let&rsquo;s start the project by creating a module, the name of my module is &ldquo;jwt&rdquo; and my username is &ldquo;1shubham7&rdquo;, therefore I will initial my module by entering:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>go mod init github.com/1shubham7/jwt
</span></span></code></pre></div><p>This will create a go.mod file.</p>
<p><strong>Step 2.</strong> Create a main.go file and let&rsquo;s create a web server in main.go. For that, add the following code in the file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span>(
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">routes</span> <span style="color:#e6db74">&#34;github.com/1shubham7/jwt/routes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/joho/godotenv&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">godotenv</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#e6db74">&#34;.env&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;Error locading the .env file&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">port</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;PORT&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">port</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">port</span> = <span style="color:#e6db74">&#34;1111&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">router</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">New</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Logger</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">routes</span>.<span style="color:#a6e22e">AuthRoutes</span>(<span style="color:#a6e22e">router</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">routes</span>.<span style="color:#a6e22e">UserRoutes</span>(<span style="color:#a6e22e">router</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// creating two APIs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/api-1&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>){
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;success&#34;</span>:<span style="color:#e6db74">&#34;Access granted for api-1&#34;</span>})
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;api-2&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>){
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;success&#34;</span>:<span style="color:#e6db74">&#34;Access granted for api-2&#34;</span>})
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">port</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>&lsquo;os&rsquo; package to retrieve environment variables.
we are using gin-gonic package to create a web server.
Later we will create a routes package.
AuthRoutes(), UserRoutes() are functions inside a file from routes package, we will create it later on.</p>
<p><strong>Step 3.</strong> Download the gin-gonic package:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>go get github.com/gin-gonic/gin
</span></span></code></pre></div><p><em><strong>Step 4.</strong></em> Create a models folder and inside it create a userModel.go file. Enter the following code inside the userModel.go:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">models</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;go.mongodb.org/mongo-driver/bson/primitive&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ID</span>            <span style="color:#a6e22e">primitive</span>.<span style="color:#a6e22e">ObjectID</span> <span style="color:#e6db74">`bson:&#34;id&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">First_name</span>    <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;first_name&#34; validate:&#34;required, min=2, max=100&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Last_name</span>     <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;last_name&#34; validate:&#34;required, min=2, max=100&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Password</span>      <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;password&#34; validate:&#34;required, min=6&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Email</span>         <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;email&#34; validate:&#34;email, required&#34;`</span> <span style="color:#75715e">//validate email means it should have an @
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Phone</span>         <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;phone&#34; validate:&#34;required&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Token</span>         <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;token&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">User_type</span>     <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;user_type&#34; validate:&#34;required, eq=ADMIN|eq=USER&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Refresh_token</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;refresh_token&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Created_at</span>    <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>          <span style="color:#e6db74">`json:&#34;created_at&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Updated_at</span>    <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>          <span style="color:#e6db74">`json:&#34;updated_at&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">User_id</span>       <span style="color:#66d9ef">string</span>             <span style="color:#e6db74">`json:&#34;user_id&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We have created a struct called User and have added necessary fields to the struct.</p>
<p><code>json:&quot;first_name&quot; validate:&quot;required, min=2, max=100&quot;</code> this are called field tags, these are used during decoding and encoding of go code to JSON and JSON to go.
Here validate:&ldquo;required, min=2, max=100&rdquo; this is used for validate that the particular field must have minimum 2 characters and maximum 100 characters.</p>
<p><strong>Step 5.</strong> Create a database folder and inside it create a databaseConnection.go file, enter the following code inside it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">database</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/joho/godotenv&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;go.mongodb.org/mongo-driver/mongo&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;go/mongodb.org/mongo-driver/mongo/options&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DBinstance</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">mongo</span>.<span style="color:#a6e22e">Client</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">godotenv</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#e6db74">&#34;.env&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;Error locading the .env file&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">MongoDb</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;THE_MONGODB_URL&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mongo</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">Client</span>().<span style="color:#a6e22e">ApplyURI</span>(<span style="color:#a6e22e">MongoDb</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">10</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Connect</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span><span style="color:#f92672">!=</span><span style="color:#66d9ef">nil</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Connected to MongoDB!!&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">client</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">Client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mongo</span>.<span style="color:#a6e22e">Client</span> = <span style="color:#a6e22e">DBinstance</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">OpenCollection</span>(<span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mongo</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">collectionName</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">mongo</span>.<span style="color:#a6e22e">Collection</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">collection</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mongo</span>.<span style="color:#a6e22e">Collection</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Database</span>(<span style="color:#e6db74">&#34;cluster0&#34;</span>).<span style="color:#a6e22e">Collection</span>(<span style="color:#a6e22e">collectionName</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">collection</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>also make sure to download the &lsquo;mongo&rsquo; package:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>go get go.mongodb.org/mongo-driver/mongo
</span></span></code></pre></div><p>Here we are connecting your mongo database with the application.</p>
<p>we are using &lsquo;godotenv&rsquo; for loading environment variables that we will set in the .env file in main directory.
The DBinstance Function, we take the value of &ldquo;THE_MONGODB_URL&rdquo; from the .env file (we will create that in the coming steps) and create a new mongoDB client using the value.
&lsquo;context&rsquo; is used to have a timeout of 10 seconds.
OpenCollection Function() takes client and collectionName as input and creates a collection for it.</p>
<p><strong>Step 6.</strong> For the routes, we will create two different files, authRouter and userRouter. authRouter includes &lsquo;/signup&rsquo; and &lsquo;/login&rsquo; . These will public to everyone so that they can authorize themselves. userRouter will not be public to everyone. It will include &lsquo;/users&rsquo; and &lsquo;/users/:user_id&rsquo;.</p>
<p>Create a folder called routes and add two files into it:</p>
<ul>
<li>userRouter.go</li>
<li>authRouter.go</li>
</ul>
<p>enter the following code into userRouter.go:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">routes</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">controllers</span> <span style="color:#e6db74">&#34;github.com/1shubham7/jwt/controllers&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">middleware</span> <span style="color:#e6db74">&#34;github.com/1shubham7/jwt/middleware&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// user should not be able to use userRoute without the token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">UserRoutes</span> (<span style="color:#a6e22e">incomingRoutes</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Engine</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">incomingRoutes</span>.<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Authenticate</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// user routes are public routes but these must be authenticated, that
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// is why we have Authenticate() before these
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">incomingRoutes</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/users&#34;</span>, <span style="color:#a6e22e">controllers</span>.<span style="color:#a6e22e">GetUsers</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">incomingRoutes</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;users/:user_id&#34;</span>, <span style="color:#a6e22e">controllers</span>.<span style="color:#a6e22e">GetUserById</span>())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Step 7.</strong> enter the following code into the authRouter.go:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">routes</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">controllers</span> <span style="color:#e6db74">&#34;github.com/1shubham7/jwt/controllers&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// this is when the user has not signed up. userRouter is when the user has logged in
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// and has the token.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">AuthRoutes</span>(<span style="color:#a6e22e">incomingRoutes</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Engine</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">incomingRoutes</span>.<span style="color:#a6e22e">POST</span>(<span style="color:#e6db74">&#34;users/signup&#34;</span>, <span style="color:#a6e22e">controllers</span>.<span style="color:#a6e22e">SignUp</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">incomingRoutes</span>.<span style="color:#a6e22e">POST</span>(<span style="color:#e6db74">&#34;user/login&#34;</span>, <span style="color:#a6e22e">controllers</span>.<span style="color:#a6e22e">Login</span>())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Step 8.</strong> create a folder called controllers and add a file called &lsquo;userController.go&rsquo; to it. enter the following code inside it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">controllers</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">database</span> <span style="color:#e6db74">&#34;github.com/1shubham7/jwt/database&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">helper</span> <span style="color:#e6db74">&#34;github.com/1shubham7/jwt/helpers&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">models</span> <span style="color:#e6db74">&#34;github.com/1shubham7/jwt/models&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/go-playground/validator/v10&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;golang.org/x/crypto/bcrypt&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">userCollection</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mongo</span>.<span style="color:#a6e22e">Collection</span> = <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">OpenCollection</span>(<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#e6db74">&#34;user&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Hashpassword</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">VerifyPassword</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">SignUp</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Login</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUsers</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserById</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">The</span> <span style="color:#a6e22e">packages</span> <span style="color:#a6e22e">used</span> <span style="color:#a6e22e">are</span> <span style="color:#a6e22e">straight</span> <span style="color:#a6e22e">forward</span>. <span style="color:#a6e22e">database</span>, <span style="color:#a6e22e">helper</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">models</span> <span style="color:#a6e22e">are</span> <span style="color:#a6e22e">our</span> <span style="color:#a6e22e">own</span> <span style="color:#a6e22e">packages</span>.
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">fmt</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#f92672">package</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">used</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">string</span> <span style="color:#a6e22e">formatting</span>.
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">time</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#f92672">package</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">used</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">time</span> <span style="color:#a6e22e">representation</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">net</span><span style="color:#f92672">/</span><span style="color:#a6e22e">http</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#f92672">package</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">used</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">dealing</span> <span style="color:#a6e22e">with</span> <span style="color:#a6e22e">requests</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">strconv</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#f92672">package</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">used</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">convert</span> <span style="color:#66d9ef">string</span> <span style="color:#a6e22e">to</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">vice</span> <span style="color:#a6e22e">versa</span>.
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Then</span> <span style="color:#a6e22e">we</span> <span style="color:#a6e22e">have</span> <span style="color:#a6e22e">just</span> <span style="color:#a6e22e">created</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">outline</span> <span style="color:#a6e22e">function</span>, <span style="color:#a6e22e">we</span> <span style="color:#a6e22e">will</span> <span style="color:#a6e22e">complete</span> <span style="color:#a6e22e">those</span> <span style="color:#a6e22e">functions</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">coming</span> <span style="color:#a6e22e">steps</span>.
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Step</span> <span style="color:#ae81ff">9.</span> <span style="color:#a6e22e">To</span> <span style="color:#a6e22e">keep</span> <span style="color:#a6e22e">environment</span> <span style="color:#a6e22e">variables</span> <span style="color:#a6e22e">in</span> <span style="color:#a6e22e">a</span> <span style="color:#a6e22e">separate</span> <span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">we</span> <span style="color:#a6e22e">will</span> <span style="color:#a6e22e">create</span> <span style="color:#a6e22e">a</span> .<span style="color:#a6e22e">env</span> <span style="color:#a6e22e">file</span> <span style="color:#a6e22e">inside</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">main</span> <span style="color:#a6e22e">folder</span> (<span style="color:#a6e22e">root</span> <span style="color:#a6e22e">folder</span>) <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">add</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">following</span> <span style="color:#a6e22e">code</span> <span style="color:#a6e22e">into</span> <span style="color:#a6e22e">it</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PORT</span>=<span style="color:#ae81ff">1111</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">THE_MONGODB_URL</span>=<span style="color:#a6e22e">mongodb</span>:<span style="color:#75715e">//localhost:27017/go-auth
</span></span></span></code></pre></div><p>These two variables have already been used in our previous code.</p>
<p><strong>Step 10.</strong> Let&rsquo;s create the GetUserById() function first. Enter the following code in GetUserById() function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserById</span>() <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>){
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">userId</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Param</span>(<span style="color:#e6db74">&#34;user_id&#34;</span>) <span style="color:#75715e">// we are taking the user_id given by the user in json
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// with the help of gin.context we can access the json data send by postman or curl or user
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">helper</span>.<span style="color:#a6e22e">MatchUserTypeToUserId</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">userId</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">//checking if the user in admin or not.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// we will create that func in helper package.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> 
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">100</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">user</span> <span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userCollection</span>.<span style="color:#a6e22e">FindOne</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">M</span>{<span style="color:#e6db74">&#34;user_id&#34;</span>: <span style="color:#a6e22e">userId</span>}).<span style="color:#a6e22e">Decode</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// if everything goes ok, pass the data of the user (UserModel.go)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Step 11.</strong> Let&rsquo;s create a folder called helpers and add a file called authHelper.go into it. Enter the following code into the authHelper.go :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">helpers</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CheckUserType</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">userOrAdmin</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">userType</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetString</span>(<span style="color:#e6db74">&#34;user_type&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">userType</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">userOrAdmin</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Not authorized to access the resource&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">MatchUserTypeToUserId</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">userId</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  This is the match user function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">userType</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetString</span>(<span style="color:#e6db74">&#34;user_type&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">uid</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetString</span>(<span style="color:#e6db74">&#34;uid&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> = <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// this means that user is USER not ADMIN and uid is not of the user. Because user can only access his id,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// admin can access anyone&#39;s id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">userId</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;USER&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">uid</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">userId</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;You are not authorized to access this user&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">CheckUserType</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">userType</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The MatchUserTypeToUserId() function just matches if the user is a Admin or just a user.
We are using CheckUserType() function inside MatchUserTypeToUserId(), this is just checking if everything is fine (if the user_type we get from user is same as the userType variable.</p>
<p><strong>Step 12.</strong> We can now work on the SignUp() function of userController.go:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">SignUp</span>()<span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>){
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">100</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">user</span> <span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">BindJSON</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>); <span style="color:#a6e22e">err</span><span style="color:#f92672">!=</span><span style="color:#66d9ef">nil</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">validationErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">validate</span>.<span style="color:#a6e22e">Struct</span>(<span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// this is used to validate, but what? see the User struct, and see those validate struct fields
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">validationErr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">validationErr</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// we are using count to help us validate. if you find documents with the user email already
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// then count would be more than 0, and we can then handle that err
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">count</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userCollection</span>.<span style="color:#a6e22e">CountDocuments</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">M</span>{<span style="color:#e6db74">&#34;email&#34;</span>:<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Email</span>})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>:<span style="color:#e6db74">&#34;error occured while checking for the email&#34;</span>})
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">password</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">HashPassword</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Password</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Password</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">password</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">count</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">userCollection</span>.<span style="color:#a6e22e">CountDocuments</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">M</span>{<span style="color:#e6db74">&#34;phone&#34;</span>:<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Phone</span>})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>:<span style="color:#e6db74">&#34;error occured while checking for the phone number&#34;</span>})
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">count</span> &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>:<span style="color:#e6db74">&#34;this email or phone number already exists&#34;</span>})
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// by &#34;c.BindJSON(&amp;user)&#34; user already have the information from the website user
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Created_at</span>, <span style="color:#a6e22e">_</span>  = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">RFC3339</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Format</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">RFC3339</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Updated_at</span>, <span style="color:#a6e22e">_</span>  = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">RFC3339</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Format</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">RFC3339</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">ID</span> = <span style="color:#a6e22e">primitive</span>.<span style="color:#a6e22e">NewObjectID</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">User_id</span> = <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">ID</span>.<span style="color:#a6e22e">Hex</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">refreshToken</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">helper</span>.<span style="color:#a6e22e">GenerateAllTokens</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Email</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">First_name</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Last_name</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">User_type</span>, <span style="color:#f92672">*&amp;</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">User_id</span>)
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// giving value that we generated to user
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Token</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">token</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Refresh_token</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">refreshToken</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// now let&#39;s insert it to the database
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">resultInsertionNumber</span>, <span style="color:#a6e22e">insertErr</span> <span style="color:#f92672">:=</span>  <span style="color:#a6e22e">userCollection</span>.<span style="color:#a6e22e">InsertOne</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">insertErr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;User item was not created&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">msg</span>})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">resultInsertionNumber</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>
<p>We created a variable user of type User.</p>
</li>
<li>
<p>validationErr is used to validate the struct tags, we already discussed this.</p>
</li>
<li>
<p>We are also using count variable to validate. As in if we find documents with the user email already then the count would be more than 0, and we can then handle that error (err)</p>
</li>
<li>
<p>Then we are using &rsquo;time.Parse(time.RFC3339, time.Now().Format(time.RFC3339))&rsquo; to set the time for Created_at, Updated_at struct fields. When the user tries to sign up, the function SignUp() will run and that particular time will be stored in  Created_at, Updated_at struct fields.</p>
</li>
<li>
<p>Then we are creating tokens using GenerateAllTokens() function that we will create in tokenHelper.go file in the same package in the next step.</p>
</li>
<li>
<p>We also have a HashPassword() function that is doing nothing but hashing the user.password and replacing the user.password with the hashed password. We will also create that thing later.</p>
</li>
<li>
<p>And then we are just inserting the data and the tokens etc. to the userCollection</p>
</li>
<li>
<p>If everything goes right, we will give StatusOK back.</p>
</li>
</ul>
<p><strong>Step 13.</strong> create a file in helpers folder called &rsquo;tokenHelper.go&rsquo; and enter the following code inside it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">helpers</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/1shubham7/jwt/database&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">jwt</span> <span style="color:#e6db74">&#34;github.com/dgrijalva/jwt-go&#34;</span> <span style="color:#75715e">// golang driver for jwt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#e6db74">&#34;go.mongodb.org/mongo-driver/bson&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;go.mongodb.org/mongo-driver/bson/primitive&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;go.mongodb.org/mongo-driver/mongo&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;go.mongodb.org/mongo-driver/mongo/options&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SignedDetails</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Email</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">First_name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Last_name</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Uid</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">User_type</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">StandardClaims</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">userCollection</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mongo</span>.<span style="color:#a6e22e">Collection</span> = <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">OpenCollection</span>(<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#e6db74">&#34;user&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// btw we sould have our secret key in .env for production 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">SECRET_KEY</span> <span style="color:#66d9ef">string</span> = <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;SECRET_KEY&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GenerateAllTokens</span>(<span style="color:#a6e22e">email</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">firstName</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">lastName</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">userType</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">uid</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">signedToken</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">signedRefreshToken</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>){
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">claims</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">SignedDetails</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Email</span> : <span style="color:#a6e22e">email</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">First_name</span>: <span style="color:#a6e22e">firstName</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Last_name</span>: <span style="color:#a6e22e">lastName</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Uid</span> : <span style="color:#a6e22e">uid</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">User_type</span>: <span style="color:#a6e22e">userType</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">StandardClaims</span>: <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">StandardClaims</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// setting the expiry time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">ExpiresAt</span>: <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Local</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Hour</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#ae81ff">120</span>)).<span style="color:#a6e22e">Unix</span>(),
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// refreshClaims is used to get a new token if th eprevious once is expired.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">refreshClaims</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">SignedDetails</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">StandardClaims</span>: <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">StandardClaims</span>{
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">ExpiresAt</span>: <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Local</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Hour</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>(<span style="color:#ae81ff">172</span>)).<span style="color:#a6e22e">Unix</span>(),
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">token</span> ,<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">NewWithClaims</span>(<span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">SigningMethodHS256</span>, <span style="color:#a6e22e">claims</span>).<span style="color:#a6e22e">SignedString</span>([]byte(<span style="color:#a6e22e">SECRET_KEY</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">refreshToken</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">NewWithClaims</span>(<span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">SigningMethodHS256</span>, <span style="color:#a6e22e">refreshClaims</span>).<span style="color:#a6e22e">SignedString</span>([]byte(<span style="color:#a6e22e">SECRET_KEY</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span><span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">refreshToken</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Also make sure to download the github.com/dgrijalva/jwt-go package:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>go get github.com/dgrijalva/jwt-go
</span></span></code></pre></div><ul>
<li>
<p>Here we are using github.com/dgrijalva/jwt-go for generating tokens.</p>
</li>
<li>
<p>We are creating a struct called SignedDetails with field names required for generating tokens.</p>
</li>
<li>
<p>we are using NewWithClaims to generate new tokens and are giving the value to the claims and refreshClaims structs. claims has token for the first time users and refreshClaims has it when the user has to refresh the token. that is, they previously had a token which is now expired.</p>
</li>
<li>
<p>time.Now().Local().Add(time.Hour *time.Duration(120)).Unix() is being used for setting the expiry of the token.</p>
</li>
<li>
<p>we are then simply returning three things - token, refreshToken and err which we are using in the SignUp() function.</p>
</li>
</ul>
<p><strong>Step 14.</strong> In the same file as SignUp() function, let&rsquo;s create the HashPassword() function we talked about in step 9.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">HashPassword</span>(<span style="color:#a6e22e">password</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">hashed</span>, <span style="color:#a6e22e">err</span><span style="color:#f92672">:=</span><span style="color:#a6e22e">bcrypt</span>.<span style="color:#a6e22e">GenerateFromPassword</span>([]byte(<span style="color:#a6e22e">password</span>), <span style="color:#ae81ff">14</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span><span style="color:#f92672">!=</span><span style="color:#66d9ef">nil</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> string(<span style="color:#a6e22e">hashed</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>
<p>We are simply using the GenerateFromPassword() method from bcrypt package which is used to generate hashed passwords from the actual password.</p>
</li>
<li>
<p>This is important because we would not want and hacker to hack into our systems and steal all the passwords, also for the users privacy.</p>
</li>
<li>
<p>[]byte (array of bytes) is simply string.</p>
</li>
</ul>
<p><strong>Step 15.</strong> Let&rsquo;s create the Login() function in &lsquo;userController.go&rsquo; and in later steps we can create the functions that Login() uses:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Login</span>() <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">100</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">user</span> <span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">foundUser</span> <span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// giving the user data to user variable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">BindJSON</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// finding the user through email and if found, storing it in foundUser variable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userCollection</span>.<span style="color:#a6e22e">FindOne</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">M</span>{<span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Email</span>}).<span style="color:#a6e22e">Decode</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">foundUser</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span><span style="color:#f92672">!=</span><span style="color:#66d9ef">nil</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;email or password is incorrect&#34;</span>})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> 
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// we need pointer to acess the origina user and foundUser,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// if we only pass user and foundUser, it will create a new instance of user and foundUser
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">isPasswordValid</span>, <span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">VerifyPassword</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Password</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">Password</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isPasswordValid</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">true</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">msg</span>})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">Email</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;user not found&#34;</span>})
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">refreshToken</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">helper</span>.<span style="color:#a6e22e">GenerateAllTokens</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">Email</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">First_name</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">Last_name</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">User_type</span>, <span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">User_id</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">helper</span>.<span style="color:#a6e22e">UpdateAllTokens</span>(<span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">refreshToken</span>, <span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">User_id</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">userCollection</span>.<span style="color:#a6e22e">FindOne</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">M</span>{<span style="color:#e6db74">&#34;user_id&#34;</span>:<span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">User_id</span>}).<span style="color:#a6e22e">Decode</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">foundUser</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">foundUser</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>
<p>We are creating two variables of type User, these are user and Founduser. and giving the data from request to user.</p>
</li>
<li>
<p>By the help of &lsquo;userCollection.FindOne(ctx, bson.M{&ldquo;email&rdquo;: user.Email}).Decode(&amp;foundUser)&rsquo; we are finding the user through his/her email and if found, storing it in foundUser variable.</p>
</li>
<li>
<p>Then we are using VerifyPassword() function to verify the password and store it, remember that we are taking pointers as parameters in VerifyPassword(), if not, it would create a new instance of those in parameters rather than actually changing them.</p>
</li>
<li>
<p>We will create VerifyPassword() in the next step.</p>
</li>
<li>
<p>Then we are simply using GenerateAllTokens() and UpdateAllTokens() to generate and update the token and refreshToken (which are basically tokens).</p>
</li>
<li>
<p>And every step, we are all handling the errors.</p>
</li>
</ul>
<p><strong>Step 16.</strong> Let&rsquo;s create the VerifyPassword() function in the same file as Login() function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">VerifyPassword</span>(<span style="color:#a6e22e">userPassword</span>, <span style="color:#a6e22e">providedPassword</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bcrypt</span>.<span style="color:#a6e22e">CompareHashAndPassword</span>([]byte(<span style="color:#a6e22e">providedPassword</span>), []byte(<span style="color:#a6e22e">userPassword</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">check</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">check</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">msg</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;email or password is incorrect.&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">check</span>, <span style="color:#a6e22e">msg</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>
<p>We are simply using the CompareHashAndPassword() method from bcrypt package which is used to compare hashed passwords. and returning a boolean value depening on the results.</p>
</li>
<li>
<p>[]byte (array of bytes) is simply string, but []byte helps in comparing.</p>
</li>
</ul>
<p><strong>Step 17.</strong> Let&rsquo;s create the UpdateAllTokens() function in the &rsquo;tokenHelper.go&rsquo; file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">UpdateAllTokens</span>(<span style="color:#a6e22e">signedToken</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">signedRefreshToken</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">userId</span> <span style="color:#66d9ef">string</span>){
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">100</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">updateObj</span> <span style="color:#a6e22e">primitive</span>.<span style="color:#a6e22e">D</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">updateObj</span> = append(<span style="color:#a6e22e">updateObj</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">E</span>{<span style="color:#e6db74">&#34;token&#34;</span>, <span style="color:#a6e22e">signedToken</span>})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">updateObj</span> = append(<span style="color:#a6e22e">updateObj</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">E</span>{<span style="color:#e6db74">&#34;refresh_token&#34;</span>, <span style="color:#a6e22e">signedRefreshToken</span>})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Updated_at</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">RFC3339</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Format</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">RFC3339</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">updateObj</span> = append(<span style="color:#a6e22e">updateObj</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">E</span>{<span style="color:#e6db74">&#34;updated_at&#34;</span>, <span style="color:#a6e22e">Updated_at</span>})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">upsert</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">filter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">M</span>{<span style="color:#e6db74">&#34;user_id&#34;</span>:<span style="color:#a6e22e">userId</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">opt</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">UpdateOptions</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Upsert</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">upsert</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userCollection</span>.<span style="color:#a6e22e">UpdateOne</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ctx</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">filter</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{
</span></span><span style="display:flex;"><span>			{<span style="color:#e6db74">&#34;$set&#34;</span>, <span style="color:#a6e22e">updateObj</span>},
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">opt</span>,
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span><span style="color:#f92672">!=</span><span style="color:#66d9ef">nil</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>
<p>We are creating a variable called updateObj which is of type primitive.D. primitive.D type in MongoDB&rsquo;s Go driver is a representation of a BSON document.</p>
</li>
<li>
<p>Append() is appending a key-value pair to updateObj each and every time its running.</p>
</li>
<li>
<p>Then &rsquo;time.Parse(time.RFC3339, time.Now().Format(time.RFC3339))&rsquo; is used to update the current time (time when the updation happens and the function runs) to Updated_at.</p>
</li>
<li>
<p>Rest of the code block is performing update using the UpdateOne method of mongoDB collection.</p>
</li>
<li>
<p>At the last step we are also handling the error in case any error occurs.</p>
</li>
</ul>
<p><strong>Step 18.</strong> Before continuing ahead, let&rsquo;s download the go.mongodb.org/mongo-driver package:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>go get go.mongodb.org/mongo-driver
</span></span></code></pre></div><p><strong>Step 19.</strong> Let&rsquo;s now work on GetUserById() function. Remember that GetUserById() is for the users to access there own information, Admins can access all the users data, users can only access theirs.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserById</span>() <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>){
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">userId</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Param</span>(<span style="color:#e6db74">&#34;user_id&#34;</span>) <span style="color:#75715e">// we are taking the user_id given by the user in json
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// with the help of gin.context we can access the json data send by postman or curl or user
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">helper</span>.<span style="color:#a6e22e">MatchUserTypeToUserId</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">userId</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">//checking if the user in admin or not.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// we will create that func in helper package.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> 
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">100</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">user</span> <span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userCollection</span>.<span style="color:#a6e22e">FindOne</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">M</span>{<span style="color:#e6db74">&#34;user_id&#34;</span>: <span style="color:#a6e22e">userId</span>}).<span style="color:#a6e22e">Decode</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// if everything goes ok, pass the data of the user (UserModel.go)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>
<p>Taking the user_id from the request and storing it in userId variable.</p>
</li>
<li>
<p>creating a variable called user of type User. then simply searching the user in our database with the help of user_id, if the user_id matches, we will store that persons information in user variable.</p>
</li>
<li>
<p>If everything goes fine, StatusOk</p>
</li>
<li>
<p>we are also handling the errors at every step.</p>
</li>
</ul>
<p><strong>Step 20.</strong>  Let&rsquo;s now work on GetUsers() function. Remember that only the admin can access the GetUsers() function because it would include the data of all the users. Create a GetUsers() function in the same file as GetUserById(), Login() and SignUp() function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUsers</span>() <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>){
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">helper</span>.<span style="color:#a6e22e">CheckUserType</span>(<span style="color:#a6e22e">c</span>, <span style="color:#e6db74">&#34;ADMIN&#34;</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>:<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">100</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//  setting how many records you want per page.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// we are taking the recodePerPage from c and converting it to int
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">recordPerPage</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Query</span>(<span style="color:#e6db74">&#34;recordPerPage&#34;</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// if error or recordPerPage is less than 1, by default we will have 9 records per page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">recordPerPage</span>&lt;<span style="color:#ae81ff">1</span><span style="color:#f92672">||</span><span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">recordPerPage</span> = <span style="color:#ae81ff">9</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// this is just like page number
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">page</span>, <span style="color:#a6e22e">err1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Query</span>(<span style="color:#e6db74">&#34;page&#34;</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// we want to start with the page number 1 by default.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err1</span> <span style="color:#f92672">!=</span><span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">page</span> &lt; <span style="color:#ae81ff">1</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">page</span> = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">startIndex</span> <span style="color:#f92672">:=</span> (<span style="color:#a6e22e">page</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">recordPerPage</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">startIndex</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Query</span>(<span style="color:#e6db74">&#34;startIndex&#34;</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">matchStage</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{{<span style="color:#e6db74">&#34;$match&#34;</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{{}},
</span></span><span style="display:flex;"><span>	}}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// group all the data based on id, and then count them using $sum. then
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// pushing all the data to the root.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">groupStage</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{{<span style="color:#e6db74">&#34;$group&#34;</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{{<span style="color:#e6db74">&#34;_id&#34;</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{{<span style="color:#e6db74">&#34;_id&#34;</span>, <span style="color:#e6db74">&#34;null&#34;</span>}}},
</span></span><span style="display:flex;"><span>		{<span style="color:#e6db74">&#34;total_count&#34;</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{{<span style="color:#e6db74">&#34;$sum&#34;</span>, <span style="color:#ae81ff">1</span>}}},
</span></span><span style="display:flex;"><span>		{<span style="color:#e6db74">&#34;data&#34;</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{{<span style="color:#e6db74">&#34;$push&#34;</span>, <span style="color:#e6db74">&#34;$$ROOT&#34;</span>}}},
</span></span><span style="display:flex;"><span>	}}}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// in project stage we deside which data should go to the user and which not.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">projectStage</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{
</span></span><span style="display:flex;"><span>			{<span style="color:#e6db74">&#34;$project&#34;</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{
</span></span><span style="display:flex;"><span>				{<span style="color:#e6db74">&#34;_id&#34;</span>, <span style="color:#ae81ff">0</span>},
</span></span><span style="display:flex;"><span>				{<span style="color:#e6db74">&#34;total_count&#34;</span>, <span style="color:#ae81ff">1</span>},
</span></span><span style="display:flex;"><span>				{<span style="color:#e6db74">&#34;user_items&#34;</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{{<span style="color:#e6db74">&#34;$slice&#34;</span>, []<span style="color:#66d9ef">interface</span>{}{<span style="color:#e6db74">&#34;$data&#34;</span>, <span style="color:#a6e22e">startIndex</span>, <span style="color:#a6e22e">recordPerPage</span>}}}},
</span></span><span style="display:flex;"><span>			}},
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userCollection</span>.<span style="color:#a6e22e">Aggregate</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">mongo</span>.<span style="color:#a6e22e">Pipeline</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">matchStage</span>, <span style="color:#a6e22e">groupStage</span>, <span style="color:#a6e22e">projectStage</span>})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>:<span style="color:#e6db74">&#34;error occured while listing user items&#34;</span>})
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// creating a slice called allUser and giving the result value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">allUsers</span> []<span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">M</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">All</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">allUsers</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		} 
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">allUsers</span>[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>
<p>Firstly, we will check if the request is coming from the admin or not, we do that by the help of CheckUserType() we created in previous steps.</p>
</li>
<li>
<p>Then we are setting how many records you want per page.</p>
</li>
<li>
<p>We can do that by taking the recodePerPage from the request and converting it to int, this is done by srtconv.</p>
</li>
<li>
<p>If any error occurs in setting recordPerPage or recordPerPage is less than 1, by default we will have 9 records per page</p>
</li>
<li>
<p>Similarly we are taking the page number in variable &lsquo;page&rsquo;.</p>
</li>
<li>
<p>By default we will have page number as 1 and 9 recordPerPage.</p>
</li>
<li>
<p>Then we created three stages (matchStage, groupStage, projectStage).</p>
</li>
<li>
<p>Then we are setting these three stages in our Mongo pipeline using Aggregate() function</p>
</li>
<li>
<p>Also we are handling errors are every step.</p>
</li>
</ul>
<p><strong>Step 21.</strong> Our &lsquo;userController.go&rsquo; is now ready, this is how the &lsquo;userController.go&rsquo; file looks like after completion:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">controllers</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">database</span> <span style="color:#e6db74">&#34;github.com/1shubham7/jwt/database&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">helper</span> <span style="color:#e6db74">&#34;github.com/1shubham7/jwt/helpers&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">models</span> <span style="color:#e6db74">&#34;github.com/1shubham7/jwt/models&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/go-playground/validator/v10&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;golang.org/x/crypto/bcrypt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;go.mongodb.org/mongo-driver/bson&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;go.mongodb.org/mongo-driver/bson/primitive&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;go.mongodb.org/mongo-driver/mongo&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">userCollection</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mongo</span>.<span style="color:#a6e22e">Collection</span> = <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">OpenCollection</span>(<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#e6db74">&#34;user&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">validate</span> = <span style="color:#a6e22e">validator</span>.<span style="color:#a6e22e">New</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">HashPassword</span>(<span style="color:#a6e22e">password</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">hashed</span>, <span style="color:#a6e22e">err</span><span style="color:#f92672">:=</span><span style="color:#a6e22e">bcrypt</span>.<span style="color:#a6e22e">GenerateFromPassword</span>([]byte(<span style="color:#a6e22e">password</span>), <span style="color:#ae81ff">14</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span><span style="color:#f92672">!=</span><span style="color:#66d9ef">nil</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> string(<span style="color:#a6e22e">hashed</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">VerifyPassword</span>(<span style="color:#a6e22e">userPassword</span>, <span style="color:#a6e22e">providedPassword</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bcrypt</span>.<span style="color:#a6e22e">CompareHashAndPassword</span>([]byte(<span style="color:#a6e22e">providedPassword</span>), []byte(<span style="color:#a6e22e">userPassword</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">check</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">check</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">msg</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;email or password is incorrect.&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">check</span>, <span style="color:#a6e22e">msg</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">SignUp</span>()<span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>){
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">100</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">user</span> <span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">BindJSON</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>); <span style="color:#a6e22e">err</span><span style="color:#f92672">!=</span><span style="color:#66d9ef">nil</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">validationErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">validate</span>.<span style="color:#a6e22e">Struct</span>(<span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// this is used to validate, but what? see the User struct, and see those validate struct fields
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">validationErr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">validationErr</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// we are using count to help us validate. if you find documents with the user email already
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// then count would be more than 0, and we can then handle that err
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">count</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userCollection</span>.<span style="color:#a6e22e">CountDocuments</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">M</span>{<span style="color:#e6db74">&#34;email&#34;</span>:<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Email</span>})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>:<span style="color:#e6db74">&#34;error occured while checking for the email&#34;</span>})
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">password</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">HashPassword</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Password</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Password</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">password</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">count</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">userCollection</span>.<span style="color:#a6e22e">CountDocuments</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">M</span>{<span style="color:#e6db74">&#34;phone&#34;</span>:<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Phone</span>})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>:<span style="color:#e6db74">&#34;error occured while checking for the phone number&#34;</span>})
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">count</span> &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>:<span style="color:#e6db74">&#34;this email or phone number already exists&#34;</span>})
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// by &#34;c.BindJSON(&amp;user)&#34; user already have the information from the website user
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Created_at</span>, <span style="color:#a6e22e">_</span>  = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">RFC3339</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Format</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">RFC3339</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Updated_at</span>, <span style="color:#a6e22e">_</span>  = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Parse</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">RFC3339</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Format</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">RFC3339</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">ID</span> = <span style="color:#a6e22e">primitive</span>.<span style="color:#a6e22e">NewObjectID</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">User_id</span> = <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">ID</span>.<span style="color:#a6e22e">Hex</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">refreshToken</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">helper</span>.<span style="color:#a6e22e">GenerateAllTokens</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Email</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">First_name</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Last_name</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">User_type</span>, <span style="color:#f92672">*&amp;</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">User_id</span>)
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// giving value that we generated to user
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Token</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">token</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Refresh_token</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">refreshToken</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// now let&#39;s insert it to the database
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">resultInsertionNumber</span>, <span style="color:#a6e22e">insertErr</span> <span style="color:#f92672">:=</span>  <span style="color:#a6e22e">userCollection</span>.<span style="color:#a6e22e">InsertOne</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">insertErr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;User item was not created&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">msg</span>})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">resultInsertionNumber</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Login</span>() <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">100</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">user</span> <span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">foundUser</span> <span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// giving the user data to user variable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">BindJSON</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// finding the user through email and if found, storing it in foundUser variable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userCollection</span>.<span style="color:#a6e22e">FindOne</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">M</span>{<span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Email</span>}).<span style="color:#a6e22e">Decode</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">foundUser</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span><span style="color:#f92672">!=</span><span style="color:#66d9ef">nil</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;email or password is incorrect&#34;</span>})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> 
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// we need pointer to acess the origina user and foundUser,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// if we only pass user and foundUser, it will create a new instance of user and foundUser
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">isPasswordValid</span>, <span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">VerifyPassword</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">Password</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">Password</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isPasswordValid</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">true</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">msg</span>})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">Email</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;user not found&#34;</span>})
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">refreshToken</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">helper</span>.<span style="color:#a6e22e">GenerateAllTokens</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">Email</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">First_name</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">Last_name</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">User_type</span>, <span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">User_id</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">helper</span>.<span style="color:#a6e22e">UpdateAllTokens</span>(<span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">refreshToken</span>, <span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">User_id</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">userCollection</span>.<span style="color:#a6e22e">FindOne</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">M</span>{<span style="color:#e6db74">&#34;user_id&#34;</span>:<span style="color:#a6e22e">foundUser</span>.<span style="color:#a6e22e">User_id</span>}).<span style="color:#a6e22e">Decode</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">foundUser</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">foundUser</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GetUsers can only be accessed by the admin.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUsers</span>() <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>){
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">helper</span>.<span style="color:#a6e22e">CheckUserType</span>(<span style="color:#a6e22e">c</span>, <span style="color:#e6db74">&#34;ADMIN&#34;</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>:<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">100</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//  setting how many records you want per page.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// we are taking the recodePerPage from c and converting it to int
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">recordPerPage</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Query</span>(<span style="color:#e6db74">&#34;recordPerPage&#34;</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// if error or recordPerPage is less than 1, by default we will have 9 records per page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">recordPerPage</span>&lt;<span style="color:#ae81ff">1</span><span style="color:#f92672">||</span><span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">recordPerPage</span> = <span style="color:#ae81ff">9</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// this is just like page number
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">page</span>, <span style="color:#a6e22e">err1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Query</span>(<span style="color:#e6db74">&#34;page&#34;</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// we want to start with the page number 1 by default.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err1</span> <span style="color:#f92672">!=</span><span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">page</span> &lt; <span style="color:#ae81ff">1</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">page</span> = <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">startIndex</span> <span style="color:#f92672">:=</span> (<span style="color:#a6e22e">page</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">recordPerPage</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">startIndex</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Query</span>(<span style="color:#e6db74">&#34;startIndex&#34;</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">matchStage</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{{<span style="color:#e6db74">&#34;$match&#34;</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{{}},
</span></span><span style="display:flex;"><span>	}}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// group all the data based on id, and then count them using $sum. then
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// pushing all the data to the root.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">groupStage</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{{<span style="color:#e6db74">&#34;$group&#34;</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{{<span style="color:#e6db74">&#34;_id&#34;</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{{<span style="color:#e6db74">&#34;_id&#34;</span>, <span style="color:#e6db74">&#34;null&#34;</span>}}},
</span></span><span style="display:flex;"><span>		{<span style="color:#e6db74">&#34;total_count&#34;</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{{<span style="color:#e6db74">&#34;$sum&#34;</span>, <span style="color:#ae81ff">1</span>}}},
</span></span><span style="display:flex;"><span>		{<span style="color:#e6db74">&#34;data&#34;</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{{<span style="color:#e6db74">&#34;$push&#34;</span>, <span style="color:#e6db74">&#34;$$ROOT&#34;</span>}}},
</span></span><span style="display:flex;"><span>	}}}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// in project stage we deside which data should go to the user and which not.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">projectStage</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{
</span></span><span style="display:flex;"><span>			{<span style="color:#e6db74">&#34;$project&#34;</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{
</span></span><span style="display:flex;"><span>				{<span style="color:#e6db74">&#34;_id&#34;</span>, <span style="color:#ae81ff">0</span>},
</span></span><span style="display:flex;"><span>				{<span style="color:#e6db74">&#34;total_count&#34;</span>, <span style="color:#ae81ff">1</span>},
</span></span><span style="display:flex;"><span>				{<span style="color:#e6db74">&#34;user_items&#34;</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">D</span>{{<span style="color:#e6db74">&#34;$slice&#34;</span>, []<span style="color:#66d9ef">interface</span>{}{<span style="color:#e6db74">&#34;$data&#34;</span>, <span style="color:#a6e22e">startIndex</span>, <span style="color:#a6e22e">recordPerPage</span>}}}},
</span></span><span style="display:flex;"><span>			}},
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userCollection</span>.<span style="color:#a6e22e">Aggregate</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">mongo</span>.<span style="color:#a6e22e">Pipeline</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">matchStage</span>, <span style="color:#a6e22e">groupStage</span>, <span style="color:#a6e22e">projectStage</span>})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>:<span style="color:#e6db74">&#34;error occured while listing user items&#34;</span>})
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// creating a slice called allUser and giving the result value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">allUsers</span> []<span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">M</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">All</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">allUsers</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		} 
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">allUsers</span>[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserById</span>() <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>){
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">userId</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Param</span>(<span style="color:#e6db74">&#34;user_id&#34;</span>) <span style="color:#75715e">// we are taking the user_id given by the user in json
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// with the help of gin.context we can access the json data send by postman or curl or user
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">helper</span>.<span style="color:#a6e22e">MatchUserTypeToUserId</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">userId</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">//checking if the user in admin or not.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// we will create that func in helper package.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> 
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">100</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">user</span> <span style="color:#a6e22e">models</span>.<span style="color:#a6e22e">User</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userCollection</span>.<span style="color:#a6e22e">FindOne</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">bson</span>.<span style="color:#a6e22e">M</span>{<span style="color:#e6db74">&#34;user_id&#34;</span>: <span style="color:#a6e22e">userId</span>}).<span style="color:#a6e22e">Decode</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// if everything goes ok, pass the data of the user (UserModel.go)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Step 22.</strong> Now we can work on the authentication part. For that we will create a authenticate middleware. Create a folder called &lsquo;middleware&rsquo; and create a file inside it called &lsquo;authMiddleware.go&rsquo;. Enter the following code in the file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">middleware</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">helpers</span> <span style="color:#e6db74">&#34;github.com/1shubham7/jwt/helpers&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Authenticate</span>() <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">clientToken</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;token&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">clientToken</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>:<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;No Authorization header provided&#34;</span>)})
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Abort</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">claims</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">helpers</span>.<span style="color:#a6e22e">ValidateToken</span>(<span style="color:#a6e22e">clientToken</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span><span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;error&#34;</span>:<span style="color:#a6e22e">err</span>})
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Abort</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;email&#34;</span>, <span style="color:#a6e22e">claims</span>.<span style="color:#a6e22e">Email</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;first_name&#34;</span>, <span style="color:#a6e22e">claims</span>.<span style="color:#a6e22e">First_name</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;last_name&#34;</span>, <span style="color:#a6e22e">claims</span>.<span style="color:#a6e22e">Last_name</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;uid&#34;</span>, <span style="color:#a6e22e">claims</span>.<span style="color:#a6e22e">Uid</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;user_type&#34;</span>, <span style="color:#a6e22e">claims</span>.<span style="color:#a6e22e">User_type</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Next</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Step 23.</strong> Now let&rsquo;s create ValidateToken() function, we will create this function in the &rsquo;tokenHelper.go&rsquo;:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ValidateToken</span>(<span style="color:#a6e22e">signedToken</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">claims</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SignedDetails</span>, <span style="color:#a6e22e">msg</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// this function is basically returning the token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">ParseWithClaims</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">signedToken</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">SignedDetails</span>{},
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">token</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">Token</span>)(<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>){
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> []byte(<span style="color:#a6e22e">SECRET_KEY</span>), <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">msg</span> = <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// checking if the token is correct or not
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">claims</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">token</span>.<span style="color:#a6e22e">Claims</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">SignedDetails</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">msg</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;the token is invalid&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">msg</span> = <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> 
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// if the token is expired, give error message
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">claims</span>.<span style="color:#a6e22e">ExpiresAt</span> &lt; <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Local</span>().<span style="color:#a6e22e">Unix</span>(){
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">msg</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;token has been expired&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">msg</span> = <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">claims</span>, <span style="color:#a6e22e">msg</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>
<p>ValidateToken takes signedToken and returns SignedDetails of that along with an error message. &quot;&quot; if there is no error.</p>
</li>
<li>
<p>ParseWithClaims() function is being used to get us the token and store it in a variable called token.</p>
</li>
<li>
<p>Then we are checking if the token is correct or not using the Claims method on token. And we are storing the result in claims variable.</p>
</li>
<li>
<p>Then we are checking if the token has expired using ExpiresAt() function, if current time is greater than the ExpiresAt time, it would have expired.</p>
</li>
<li>
<p>And then simply return the claims variable as well as the message.</p>
</li>
</ul>
<p><strong>Step 24.</strong> We are mostly done now, let&rsquo;s do &lsquo;go mod tidy&rsquo;, this command checks in your go.mod file, it deletes all the packages/dependencies that we installed but are not using and downloads any dependencies that we are using but haven&rsquo;t downloaded yet.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>go mod tidy
</span></span></code></pre></div><p><img loading="lazy" src="/blog/jwt/two.png" alt="Output"  />
</p>
<h2 id="output">Output<a hidden class="anchor" aria-hidden="true" href="#output">#</a></h2>
<p>With that our JWT authentication project is ready, to finally run the application enter the following command in the terminal:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>go run main.go
</span></span></code></pre></div><p>You will get a similar output:</p>
<p><img loading="lazy" src="/blog/jwt/three.png" alt="Output"  />
</p>
<p>This will get the server up and running, and you can use curl or Postman API for sending request and receiving response. Or you can simply integrate this API with an frontend framework. And with that, our authentication API is ready, pat yourself on the back!</p>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>In this article we discussed one of the fastest ways to create JWT authentication, we used Gin-Gonic framework for our project. This is not your &ldquo;just another authentication API&rdquo;. Gin is 300% faster than NodeJS, that makes this authentication API really fast and efficient. The project structure we are using is also an industry level project structure. You can make further changes like storing the SECRET_KEY in the .env file and a lot more to make this API better. You can also find the source code for this project here - <a href="https://github.com/1Shubham7/go-jwt-token"><strong>1Shubham7/go-jwt-token</strong></a>.</p>
<p>Make sure to follow all the steps in order to create the project and add some more functionality and just play with the code to understand it better. The best way to learn authentication is to create your own projects.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/golang/">Golang</a></li>
      <li><a href="http://localhost:1313/tags/backend/">Backend</a></li>
      <li><a href="http://localhost:1313/tags/gin/">Gin</a></li>
      <li><a href="http://localhost:1313/tags/jwt-authentication/">JWT Authentication</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="http://localhost:1313/">Shubham Singh</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
